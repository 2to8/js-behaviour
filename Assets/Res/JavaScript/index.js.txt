(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('csharp'), require('puerts')) :
    typeof define === 'function' && define.amd ? define(['exports', 'csharp', 'puerts'], factory) :
    (global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.index = {}, global.csharp, global.puerts));
}(this, (function (exports, csharp, puerts) { 'use strict';

    /*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */

    function __decorate(decorators, target, key, desc) {
        var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
        if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
        else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
        return c > 3 && r && Object.defineProperty(target, key, r), r;
    }

    /**
     * 组件接口，回调时机同unity的mono behaviour
     */
    class Component {
        BindProperty(instanceId) {
            console.log(`instanceId = ${instanceId}`);
            this.behaviour = csharp.Base.Runtime.JsBehaviourMgr.Instance.Get(instanceId);
            this.compInfo = this["componentInfo"];
            for (let propName in this.compInfo.properties) {
                const propInfo = this.compInfo.properties[propName];
                this[propInfo.name] = this.GetPropertyValue(propInfo);
            }
        }
        UnbindProperty() {
            for (let propName in this.compInfo.properties) {
                const propInfo = this.compInfo.properties[propName];
                this[propInfo.name] = undefined;
            }
        }
        GetPropertyValue(propInfo) {
            switch (propInfo.type) {
                case "System.Single":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetFloatList(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetFloat(propInfo.name);
                case "System.String":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetStringList(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetString(propInfo.name);
                case "System.Int32":
                case "System.UInt32":
                case "System.Int16":
                case "System.UInt16":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetIntList(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetInt(propInfo.name);
                case "System.Int64":
                case "System.UInt64":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetLongList(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetLong(propInfo.name);
                case "UnityEngine.Vector2":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetVector2List(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetVector2(propInfo.name);
                case "UnityEngine.Vector3":
                    return propInfo.isArray ?
                        this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetVector3List(propInfo.name)) :
                        this.behaviour.JsComponentProp.GetVector3(propInfo.name);
                default:
                    if (this.behaviour.JsComponentProp.IsUEObject(propInfo.type)) {
                        return propInfo.isArray ?
                            this.ConvertTypedListToArray(this.behaviour.JsComponentProp.GetUEObjectList(propInfo.name)) :
                            this.behaviour.JsComponentProp.GetUEObject(propInfo.name);
                    }
                    return undefined;
            }
        }
        ConvertTypedListToArray(list) {
            let array = [];
            if (list?.Data == null) {
                return array;
            }
            for (let i = 0; i < list?.Data.Count; ++i) {
                array.push(list.Data.get_Item(i));
            }
            return array;
        }
        compInfo;
        behaviour;
    }

    /**
     * 组件信息管理
     */
    class ComponentInfoMgr {
        /**
         * 获取指定名字的组件信息JSON字符串，名字为空时返回所有组件信息
         * @param componentName 组件名字
         * @returns json格式的组件信息字符串
         */
        getJsonString(componentName) {
            if (!componentName) {
                return JSON.stringify(this.componentInfos);
            }
            const componentInfo = this.componentInfos[componentName];
            if (!componentInfo) {
                return null;
            }
            return JSON.stringify(componentInfo);
        }
        /**
         * 获取指定名字的组件信息，名字不能为空
         * @param componentName 组件名
         * @returns 组件信息
         */
        getComponentInfo(componentName) {
            return this.componentInfos[componentName];
        }
        /**
         * 注册组件
         * @param name 组件名字
         * @param cls 组件类
         * @param path 组件在编辑器的inspector面板显示的索引路径
         */
        registerComponent(name, cls, path) {
            let compInfo = this.componentInfos[name];
            if (!compInfo) {
                compInfo = {
                    name,
                    path,
                    properties: {}
                };
                this.componentInfos[name] = compInfo;
            }
            if (cls) {
                this.componentClass[name] = cls;
            }
            compInfo.path = compInfo.path || path;
        }
        /**
         * 向组件中添加组件的属性信息
         * @param component 组件名字
         * @param propInfo 组件信息
         */
        addPropertyToComponent(component, propInfo) {
            this.registerComponent(component);
            const comp = this.componentInfos[component];
            comp.properties[propInfo.name] = propInfo;
        }
        /**
         * 查找组件构造函数
         * @param component 组件名
         * @returns 组件构造函数
         */
        findComponentConstructor(component) {
            return this.componentClass[component];
        }
        componentClass = {};
        componentInfos = {};
    }
    const compInfoMgr = new ComponentInfoMgr();

    /**
     * 组件类修饰器工厂，应用在非静态类上
     * @param componentPath 组件在编辑器的inspector面板显示的索引路径
     * @returns 组件修饰器
     */
    function component(componentPath) {
        return function (constructor) {
            compInfoMgr.registerComponent(constructor.name, constructor, componentPath);
            constructor.prototype.componentInfo = compInfoMgr.getComponentInfo(constructor.name);
        };
    }
    function property(arg) {
        return function (target, propertyKey) {
            let propInfo = null;
            if (typeof arg === 'function') {
                propInfo = {
                    name: propertyKey,
                    type: puerts.$typeof(arg).FullName,
                    isArray: false,
                };
            }
            else if (Array.isArray(arg)) {
                propInfo = {
                    name: propertyKey,
                    type: puerts.$typeof(arg[0]).FullName,
                    isArray: true,
                };
            }
            else {
                const isArray = Array.isArray(arg.type);
                propInfo = {
                    name: propertyKey,
                    type: isArray ? puerts.$typeof(arg.type[0]).FullName : puerts.$typeof(arg.type).FullName,
                    isArray: (arg.isArray === null || arg.isArray === undefined) ? isArray : arg.isArray,
                    editable: arg.editable
                };
            }
            compInfoMgr.addPropertyToComponent(target.constructor.name, propInfo);
        };
    }

    class ComponentInstMgr {
        /**
         * 给定一个组件类名，创建对应的实例
         * @param className 组件类名
         * @returns 返回实例ID
         */
        newComponent(className) {
            const componentCls = compInfoMgr.findComponentConstructor(className);
            if (!componentCls) {
                console.error(`cannot find component constructor ${className}.`);
                return InvalidComponentID;
            }
            const componentId = ++this.componentIdSeed;
            this.components[componentId] = new componentCls();
            return componentId;
        }
        /**
         * 删除一个组件实例
         * @param componentId 组件实例ID
         */
        delComponent(componentId) {
            delete this.components[componentId];
        }
        /**
         * 获取组件实例上的一个方法名
         * @param componentId 组件实例ID
         * @param methodName 方法名
         * @returns 绑定组件实例后的方法
         */
        getComponentMethod(componentId, methodName) {
            const componentInst = this.components[componentId];
            if (!componentInst) {
                console.error(`cannot find component with id ${componentId}.`);
                return undefined;
            }
            const method = componentInst[methodName];
            if (!method) {
                return undefined;
            }
            return method.bind(componentInst);
        }
        componentIdSeed = 0;
        components = {};
    }
    const InvalidComponentID = -1;
    const compInstMgr = new ComponentInstMgr;

    /**
     * 使用component修饰器定义TestBehaviour为Js组件
     */
    let TestBehaviour = class TestBehaviour extends Component {
        /**
         * 使用property修饰器定义需要在Inspector上显示的属性及其类型
         */
        prop1;
        /**
         * editable未实现，仅演示功能扩展模式
         */
        prop2;
        /**
         * 数组的几种定义形式
         */
        prop3;
        prop4;
        prop5;
        prop6;
        prop7;
        Awake() {
            // logging_trace_with_error.js
            let test = {
                add(x, y) {
                    console.log(new Error().stack);
                    return x + y;
                },
                calc() {
                    return this.add(8, 11) + this.add(9, 14);
                },
                main() {
                    this.add(2, 3);
                    this.calc();
                },
            };
            global.testScript = (mb) => {
                mb.script = this;
                console.log("test hello");
                mb.script.SayHello();
            };
            test.main();
            console.log('Awake');
            //console.log(xxx.xxx);
            console.log(`prop1 = ${this.prop1}`);
            console.log(`prop2 = ${this.prop2}`);
            console.log(`prop3 = ${this.prop3}`);
            console.log(`prop4 = ${this.prop4.length}`);
            console.log(`prop5 = ${this.prop5}`);
            console.log(`prop6 = ${this.prop6}`);
            console.log(`prop7 = {${this.prop7.x}, ${this.prop7.y}, ${this.prop7.z}}`);
        }
        Start() {
            console.log('Start');
        }
        SayHello() {
            console.log("Hello, not bad!");
        }
        OnEnable() {
            console.log('OnEnable');
        }
        OnDisable() {
            console.log('OnDisable');
        }
        OnDestroy() {
            console.log('OnDestroy');
        }
    };
    __decorate([
        property(csharp.UnityEngine.GameObject)
    ], TestBehaviour.prototype, "prop1", void 0);
    __decorate([
        property({
            type: csharp.System.Single, editable: true,
        })
    ], TestBehaviour.prototype, "prop2", void 0);
    __decorate([
        property({
            type: csharp.UnityEngine.GameObject, isArray: true,
        })
    ], TestBehaviour.prototype, "prop3", void 0);
    __decorate([
        property([csharp.UnityEngine.Vector3])
    ], TestBehaviour.prototype, "prop4", void 0);
    __decorate([
        property({
            type: [csharp.System.UInt32],
        })
    ], TestBehaviour.prototype, "prop5", void 0);
    __decorate([
        property(csharp.UnityEngine.Camera)
    ], TestBehaviour.prototype, "prop6", void 0);
    __decorate([
        property(csharp.UnityEngine.Vector3)
    ], TestBehaviour.prototype, "prop7", void 0);
    TestBehaviour = __decorate([
        component()
    ], TestBehaviour);
    let UserBehaviour1 = class UserBehaviour1 {
    };
    UserBehaviour1 = __decorate([
        component('User')
    ], UserBehaviour1);
    let UserBehaviour2 = class UserBehaviour2 {
    };
    UserBehaviour2 = __decorate([
        component('User')
    ], UserBehaviour2);
    let UserBehaviour3 = class UserBehaviour3 {
    };
    UserBehaviour3 = __decorate([
        component('User')
    ], UserBehaviour3);
    let SystemBehaviour1 = class SystemBehaviour1 {
    };
    SystemBehaviour1 = __decorate([
        component('System')
    ], SystemBehaviour1);
    let SystemBehaviour2 = class SystemBehaviour2 {
    };
    SystemBehaviour2 = __decorate([
        component('System')
    ], SystemBehaviour2);
    let SystemBehaviour3 = class SystemBehaviour3 {
    };
    SystemBehaviour3 = __decorate([
        component('System')
    ], SystemBehaviour3);

    exports.InvalidComponentID = InvalidComponentID;
    exports.compInfoMgr = compInfoMgr;
    exports.compInstMgr = compInstMgr;

    Object.defineProperty(exports, '__esModule', { value: true });

})));
//# sourceMappingURL=index.js.txt.map
